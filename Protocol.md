### TMTP Protocol

Each message starts with a header, wherein four hex digits give the size of a JSON metadata object, 
which may be followed by arbitrary format 8-bit data: 
`001f{ ... <"dataLen":uint> }dataLen 8-bit bytes of data`

Messages are not interleaved/multiplexed; that should be considered for a later revision.

Link errors & timeouts cause the server to close the connection without notice. 
Protocol errors or login failure by TMTP clients cause the server to close the connection 
after emitting a quit response:  
`{"op":"quit", "error":string}`

Ack responses from the server have the following required headers:  
`"id":string, "msgid":string, "posted":string, <"error":string>`

Messages from the server have the following required message headers:  
`"id":string, "from":string, "posted":string, "headsum":uint`

Id strings generated by the server (ack.msgid & message.id) must be sequential, 
but need not be contiguous. An easy way to generate them is to contact an NTP 
(network time protocol) server on startup for the current time, calculate the number of 
nanoseconds since the epoch, and increment that value for each id string generated. 
This supports generation of up to 1B ids per second, and doesn't require a persistent 
record of the last id generated before shutdown.

#### Client messages, with resulting server messages

After the client completes a login or register request, either side may contact the other.

0. TmtpRev gives the latest recognized protocol version; it must be the first message.  
`{"op":0, "id":"1"}`  
Response `{"op":"tmtprev", "id":"1"}`

0. Register creates a user and client queue.  
_todo: receive-only accounts which cannot ping or post_  
_todo: integrate with third party authentication services_  
`{"op":1, "newnode":string <,"newalias":string>}`  
.newnode is the user label for a client device  
Response _same as Login_  
At node `{"op":"registered", "uid":string, "nodeid":string <,"error":string>}`

0. Login connects a client to its queue.  
`{"op":2, "uid":string, "node":string}`  
Response `{"op":"info" "info":string, "ohi":[string,...]}`  
At nodes `{"op":"login", (message headers), "datalen":0, "node":string}`

0. UserEdit updates a user account.  
_todo: check & store label_  
_todo: dropnode and dropalias; prevent account hijacking from stolen client/nodeid_  
_todo: cork stops delivery to user's nodes, params date & for-list_  
`{"op":3, "id":string, <"newnode":string | "newalias":string>}`  
.newnode is the user label for a client device  
Response `{"op":"ack", (ack headers)}`  
At nodes `{"op":"user", (message headers), "datalen":0, <"newnode":string, "nodeid":string | "newalias":string>}`  
"user" messages have higher priority than normal messages.

0. OhiEdit notifies selected contacts of a user's presence. 
On first request after login, no "ohiedit" message is sent to user's nodes.  
`{"op":4, "id":string, "for":[{"id":string}, ...], "type":"add|drop"}`  
Response `{"op":"ack", (ack headers)}`  
At nodes `{"op":"ohiedit", (message headers), datalen:0, "for":[{"id":string}, ...], "type":"add|drop"}`  
At recipient `{"op":"ohi", "from":string, "status":uint}`

0. GroupInvite invites someone to a group, creating it if necessary.  
`{"op":5, "id":string, "gid":string, "datalen":uint, <"datahead":uint>, <"datasum":uint>, "from":string, "to":string}`  
Response `{"op":"ack", (ack headers)}`  
At recipient `{"op":"invite", (message headers), "datalen":uint, <"datahead":uint>, <"datasum":uint>, "gid":string, "to":string}`  
At members `{"op":"member", (message headers), "datalen":0, "act":string, "gid":string, "alias":string, <"newalias":string>}`

0. GroupEdit updates a group.  
_todo: moderated group_  
_todo: closed group publishes aliases to moderators_  
`{"op":6, "id":string, "act":"join" , "gid":string, <"newalias":string>}`  
`{"op":6, "id":string, "act":"alias", "gid":string, "newalias":string}`  
`{"op":6, "id":string, "act":"drop" , "gid":string, "to":string}`  
Response `{"op":"ack", (ack headers)}`  
At members `{"op":"member", (message headers), "datalen":0, "act":string, "gid":string, "alias":string, <"newalias":string>}`

0. Post sends a message to users and/or groups.  
`{"op":7, "id":string, "datalen":uint, <"datahead":uint>, <"datasum":uint>, "for":[<{"id":string, "type":uint}, ...>]}`  
.for[i].type: 1) user_id, 2) group_id (include self) 3) group_id (exclude self)  
.for[]: only nodes of self  
Response `{"op":"ack", (ack headers)}`  
At recipient `{"op":"delivery", (message headers), "datalen":uint, <"datahead":uint>, <"datasum":uint>}`

0. PostNotify sends a message to users/groups and a separate notification to a larger set of users/groups.  
`{"op":8, "id":string, "datalen":uint, <"datahead":uint>, <"datasum":uint>,`  
` "for":[{"id":string, "type":uint}, ...], <"fornotself":true>,`  
` "notelen":uint, <"notehead":uint>, <"notesum":uint>, <"notefor":[{"id":string, "type":uint}, ...]>}`  
.notelen segment follows the header and is sent to the .notefor & .for lists and nodes of self  
.datasum pertains to data following .notelen with length (.datalen - .notelen)  
.fornotself excludes nodes of self, which are otherwise implicit in .for list  
Response `{"op":"ack", (ack headers)}` (ack.msgid = delivery.id = notify.postid)  
At recipient `{"op":"delivery", (message headers), "datalen":uint, <"datahead":uint>, <"datasum":uint>, "notify":uint}`  
At notified `{"op":"notify", (message headers), "datalen":uint, <"datahead":uint>, <"datasum":uint>, "postid":string}`

0. Ping sends a short text message via a user's alias.
A reply establishes contact between the parties.  
_todo: limit number of pings per 24h and consecutive failed pings_  
`{"op":9, "id":string, "datalen":uint, <"datahead":uint>, <"datasum":uint>, "to":string}`  
Response `{"op":"ack", (ack headers)}`  
At recipient `{"op":"ping", (message headers), "datalen":uint, <"datahead":uint>, <"datasum":uint>, "to":string}`

0. Ack acknowledges receipt of a message.  
`{"op":10, "id":string, "type":string}`

0. Pulse resets the connection timeout.  
`{"op":11}`

0. Quit performs logout.  
`{"op":12}`


### License

Copyright 2017, 2018, 2019 Liam Breck  
Published at https://github.com/networkimprov/mnm

This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at http://mozilla.org/MPL/2.0/

